<html>
  <head>
    <title>WebSocket Beatlounge</title>
    <style>
      body {min-width: 600px; }
      #right {width: 50%; float: left;}
      #output { white-space: pre; width: 100%; height: 90%; overflow: auto;}

      #left {width: 49%; float: left; padding-right: 1%}
      #inputRecordContainer {
        width:100%; height: 38%; margin: 0.5em 0;
      }
      #inputRecordContainerButtons {
        height: 25px;
      }
      #inputDiv {
        white-space: pre;
        margin: 0.5em 0; height:80%; overflow: auto;
      }
      .restoreDelete {
        width: 150px;
        float: left;
      }
      #restore { width: 100%; height: 12%; overflow: auto;}
      .clear { clear: both; }
      #textareaContainer { width: 100%;}
      textarea#input { width: 100%;}
    </style>
  </head>
  <body>
    <div id="left">
      <h3>Send Text to the Beatlounge</h3>
      <div id="conn_status">Not Connected</div>

      <div id="inputRecordContainer">
        <div id="inputRecordContainerButtons">
          <button id="runInputDiv">Run</button>
          <button id="editInputDiv">Edit</button>
          <button id="clearCurrent">Clear the Current Code</button>
        </div>
        <div id="inputDiv"></div>
        <div id="save">
          <input type="text" id="saveAs">
          <button id="saveAsButton">Save</button>
        </div>
      </div>
  
      <div id="restore"></div>
      <div class="clear"></div>
  
  
      <div id="textareaContainer">
        <button id="inputButton">Run!</button>
        <button id="inputReplace">Replace</button>
        <br>
        <textarea id="input" rows=20 cols=80></textarea>
      </div>
    </div>
    <div id="right">
      <h3>Output</h3>
      <div id="output"></div>
    </div>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" ></script>
    <script language='javascript'>
      var db = localStorage;
      var ws = new WebSocket("ws://localhost:8080/code");

      function nl2br_js(str) {
        var regX = /\n/gi ;
        s = new String(str);
        s = s.replace(regX, "\n");
        return s;
      }
      function br2nl_js(str) {
        var regX = /<br \/>/gi;
        var regX2 = /<br>/gi;
        var regX3 = /<br\/>/gi;
        var trailingWhitespace = /\s*\n/g;
        var trailingNew = /\n*$/g;
        s = new String(str);
        s = s.replace(regX, "");
        s = s.replace(regX2, "");
        s = s.replace(regX3, "");
        s = s.replace(trailingWhitespace, "\n");
        s = s.replace(trailingNew, "\n");
        return s;
      }

      function handle_storage(e) {
        if (!e) { e = window.event; }
        console.log('handle_storage');
        console.log(e);
      }

      function show_saved() {
        $('div#restore').html('');
        if (db['___saved'] != undefined){
          var arr = db['___saved'].split(':::');
          for (var i=0; i < arr.length; i++) {
            $('div#restore').append(
'<div class="restoreDelete"><a href="#" class="restoreA">'+arr[i]+'</a> <a href="#" class="deleteA">X</a></div>'
            );
          }
        }
      }
      function record_container_buttons() {
        if ($('#inputDiv').html() == '') {
          $('#inputRecordContainer button').hide();
          $('#inputRecordContainer #save').hide();
        } else {
          $('#inputRecordContainer button').show();
          $('#inputRecordContainer #save').show();
        }
      }
      function text_area_buttons() {
        if ($('textarea#input').val() == '') {
          $('#textareaContainer button').hide();
        } else {
          $('#textareaContainer button').show();
        }
      }
      function show_current() {
        $('#inputDiv').html(nl2br_js(db['___current']));
        record_container_buttons();
      }
      function clear_and_focus() {
        $('#output').html('');
        $('textarea#input').val('');
        $('textarea#input').focus();
      }
      $(function(){
        db['___current'] = '';
        show_current();
        show_saved();
        record_container_buttons();
        
        if (window.addEventListener) {
          window.addEventListener("storage", handle_storage, false);
        } else {
          window.attachEvent("onstorage", handle_storage);
        };

        ws.onmessage = function(evt) {
          d = evt.data;
          d = nl2br_js(d);
          $('div#output').append('<p>'+d+'</p>');
        }
        ws.onopen = function(evt) {
          $('#conn_status').html('<b>Connected</b>');
        }
        ws.onerror = function(evt) {
          $('#conn_status').html('<b>Error</b>');
        }
        ws.onclose = function(evt) {
          $('#conn_status').html('<b>Closed</b>');
        }

        // USER EVENTS
        $('button#inputButton').click(function() {
          var code = $('textarea#input').val();
          ws.send(code);
          db['___current'] = db['___current'] + code + '\n';
          show_current();
          clear_and_focus();
        });
        $('button#inputReplace').click(function() {
          db['___current'] = $('textarea#input').val();
          show_current();
          clear_and_focus();
        });
        $('button#runInputDiv').click(function() {
          var code = br2nl_js($('#inputDiv').html());
          ws.send(code);
        });


        $('button#saveAsButton').click(function() {
          var save_as = $('input#saveAs').val();
          db[save_as] = db['___current'];
          var saved_string = db['___saved'];
          if (saved_string.match(':::'+save_as) == null && saved_string.match(save_as+':::') == null) {
            db['___saved'] = db['___saved'] + ':::' + save_as;
          }
          show_saved();
        });

        $('a.restoreA').live("click", function() {
          var name = $(this).html();
          $('input#saveAs').val(name);
          db['___current'] = db[name];
          $('#output').html('');
          $('textarea#input').val('');
          show_current();
          return false;
        });
        $('a.deleteA').live("click", function() {
          var name = $(this).prev().html();
          var saved = db['___saved'];
          saved = saved.replace(name+':::', '');
          saved = saved.replace(':::'+name, '');
          db['___saved'] = saved;
          db[name] = '';
          show_saved();
          return false;
        });

        $('button#clearCurrent').click(function() {
          db['___current'] = '';
          $('#inputDiv').html('');
          $('input#saveAs').val('');
          show_current();
        });

        $('button#editInputDiv').click(function() {
          var input_html = $('div#inputDiv').html();
          $('textarea#input').val(br2nl_js(input_html));
          $('#output').html(input_html)
          db['___current'] = '';
          show_current(); 
        });
      });
    </script>
  </body>
</html>

