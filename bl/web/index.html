<html>
  <head>
    <title>Twisted BeatLounge</title>
    <link id="bespin_base" href=".">
    <link rel="stylesheet" href="./BespinEmbedded.css">
    <style type="text/css">.bespin {width: 97%; height: 90%;}</style>
    <link rel="stylesheet" href="style.css" type="text/css">
  </head>
  <body>
    <div id="body">
      <div id="topStatus">
        <div id="outputHeader" style="float:right;"><strong>Output/Preview</strong><button id="clearOutput">Clear</button></div>
        <div id="conn_status">Not Connected</div>
      </div>
      <div class="clear"></div>
      <div id="left">
        <div id="leftInner">
          <div id="textareaContainer">
            <button id="runSaveButton">Run and update</button>
            <button id="runOnly">Run without update</button>
            <button id="runSelection">Run Selection</button>
            <button id="inputReplace">Replace</button>
            <br>
            <div id="editor" class="bespin" data-bespinoptions='{ "stealFocus":true}'></div>
          </div>
          <div id="restoreContainer">
            <div id="restore"></div>
            <div class="clear"></div>
          </div>
          <div id="inputRecordContainer">
            <div id="save">
              <input type="text" id="saveAs">
              <button id="saveAsButton">Save</button>
            </div>
            <div id="inputRecordContainerButtons">
              <button id="runInputDiv">Run</button>
              <button id="editInputDiv">Edit</button>
              <button id="clearCurrent">Clear the Current Code</button>
            </div>
            <div id="inputDiv"></div>
          </div>
        </div>
      </div>
      <div id="right">
        <div id="output"></div>
      </div>
    </div>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" ></script>
    <script src="./BespinEmbedded.js"></script>
    <script language='javascript'>
      var db = localStorage;
      var ws = new WebSocket("ws://localhost:8080/code");
      var editdiv = document.getElementById('editor');

      function br2nl_js(str) {
        var regX = /<br \/>/gi;
        var regX2 = /<br>/gi;
        var regX3 = /<br\/>/gi;
        var trailingWhitespace = /\s*\n/g;
        var trailingNew = /\n*$/g;
        s = new String(str);
        s = s.replace(regX, "");
        s = s.replace(regX2, "");
        s = s.replace(regX3, "");
        s = s.replace(trailingWhitespace, "\n");
        s = s.replace(trailingNew, "\n");
        s = s.replace(/&lt;/g, "<")
        s = s.replace(/&gt;/g, ">");
        return s;
      }

      /* why does this never get called? */
      function handle_storage(e) {
        if (!e) { e = window.event; }
        console.log('handle_storage');
        console.log(e);
      }

      $(window).resize(function() {
        //$('body').prepend('<div>' + $(window).width() + '</div>');
        //editdiv.bespin.dimensionsChanged();
      });


      function show_saved() {
        $('div#restore').html('');
        if (db['___saved'] == undefined) { db['___saved'] = new String("");}
        var s = db['___saved'];
        s = s.replace(/^:{3}/g, "");
        s = s.replace(/:{3}$/g, "");
        db['___saved'] = s;
        if (db['___saved'] != undefined && db['___saved'] != ''){
          var arr = db['___saved'].split(':::');
          for (var i=0; i < arr.length; i++) {
            $('div#restore').append(
'<div class="restoreDelete"><a href="#" class="restoreA">'+arr[i]+'</a> <a href="#" class="deleteA">X</a></div>'
            );
          }
        }
      }

      function record_container_buttons() {
        if ($('#inputDiv').html() == '') {
          $('#inputRecordContainer button').hide();
          $('#inputRecordContainer #save').hide();
        } else {
          $('#inputRecordContainer button').show();
          $('#inputRecordContainer #save').show();
        }
      }
      function text_area_buttons() {
        if (editor.value == '') {
          $('#textareaContainer button').hide();
        } else {
          $('#textareaContainer button').show();
        }
      }
      function show_current() {
        $('#inputDiv').html(db['___current']);
        record_container_buttons();
      }
      function clear_and_focus() {
        $('#output').html('');
        editdiv.bespin.editor.value = '';
        //$('textarea#input').focus();
      }
      $(function(){
        db['___current'] = '';
        show_current();
        show_saved();
        record_container_buttons();
        
        if (window.addEventListener) {
          window.addEventListener("storage", handle_storage, false);
        } else {
          window.attachEvent("onstorage", handle_storage);
        };

        ws.onmessage = function(evt) {
          d = evt.data;
          $('div#output').append('<p>'+d+'</p>');
        }
        ws.onopen = function(evt) {
          $('#conn_status').html('<b>Connected</b>');
        }
        ws.onerror = function(evt) {
          $('#conn_status').html('<b>Error</b>');
        }
        ws.onclose = function(evt) {
          $('#conn_status').html('<b>Closed</b>');
        }

        // USER EVENTS
        $('button#runSaveButton').click(function() {
          var code = editdiv.bespin.editor.value;
          ws.send(code);
          db['___current'] = db['___current'] + code + '\n';
          show_current();
          //$('textarea#input').val('');
        });
        $('button#runOnly').click(function() {
          var code = editdiv.bespin.editor.value;
          ws.send(code);
          //clear_and_focus();
        });
        $('button#runSelection').click(function() {
          var code = editdiv.bespin.editor.selectedText;
          ws.send(code+'\n');
        });
        $('button#inputReplace').click(function() {
          db['___current'] = editdiv.bespin.editor.value;
          show_current();
          //clear_and_focus();
        });
        $('button#runInputDiv').click(function() {
          var code = br2nl_js($('#inputDiv').html());
          ws.send(code);
        });


        $('button#saveAsButton').click(function() {
          var save_as = $('input#saveAs').val();
          db[save_as] = db['___current'];
          var saved_string = db['___saved'];
          if (saved_string == undefined) { saved_string= new String('');}
          if (saved_string.match(':::'+save_as) == null && saved_string.match(save_as+':::') == null) {
            db['___saved'] = db['___saved'] + ':::' + save_as;
          }
          show_saved();
        });
        $('a.restoreA').live("click", function() {
          var name = $(this).html();
          $('input#saveAs').val(name);
          db['___current'] = db[name];
          $('#output').html('');
          //$('textarea#input').val(db['___current']);
          show_current();
          return false;
        });
        $('a.deleteA').live("click", function() {
          var name = $(this).prev().html();
          var saved = db['___saved'];
          saved = saved.replace(name+':::', '');
          saved = saved.replace(':::'+name, '');
          db['___saved'] = saved;
          db[name] = '';
          show_saved();
          return false;
        });

        $('button#clearCurrent').click(function() {
          db['___current'] = '';
          $('#inputDiv').html('');
          $('input#saveAs').val('');
          show_current();
        });
        $('button#editInputDiv').click(function() {
          var input_html = $('div#inputDiv').html();
          editdiv.bespin.editor.value = br2nl_js(input_html);
          $('#output').html(input_html);
          db['___current'] = '';
          show_current(); 
        });

        $('button#clearOutput').click(function() {
          $('div#output').html('');
        });
      });
    </script>
  </body>
</html>

