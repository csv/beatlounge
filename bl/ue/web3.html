<!DOCTYPE html> 
<html lang="en">
<head> 
<meta charset="UTF-8"> 
<meta name="robots" content="noindex"> 
<title>BL Gridz</title> 
</head> 

<body>
<div id="conn_status"></div>

<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script> 
// factor to utils or sth
function divmod(num, div){ return [Math.floor(num/div), num%div]}


var ws = new WebSocket("ws://localhost:8347/test");
var kBoardWidth = 12;
var kBoardHeight= 8;
var kPieceWidth = 25;
var kPieceHeight= 25;
var kPixelWidth = 1 + (kBoardWidth * kPieceWidth);
var kPixelHeight= 1 + (kBoardHeight * kPieceHeight);

function Cell(row, col) {
    this.row = row;
    this.col = col;
}

function getCursorPosition(e) {
    var x;
    var y;
    if (e.pageX != undefined && e.pageY != undefined) {
    	x = e.pageX;
    	y = e.pageY;
    }
    else {
    	x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
    	y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }
    x -= e.currentTarget.offsetLeft;
    y -= e.currentTarget.offsetTop;
    x = Math.min(x, kBoardWidth * kPieceWidth);
    y = Math.min(y, kBoardHeight * kPieceHeight);
    var cell = new Cell(Math.floor(y/kPieceHeight), Math.floor(x/kPieceWidth));
    return cell;
}

function insertNumbers(context) {
  var n = 0;
  for (var y=kPieceHeight-(kPieceHeight/3); y <=kPixelHeight; y+=kPieceHeight){
    for (var x=kPieceWidth/4; x <= kPixelWidth; x+=kPieceWidth){
      context.fillText(n, x, y);
      n++;
    }
  }
}

function drawBoard(context, selected) {
    context.clearRect(0, 0, kPixelWidth, kPixelHeight);
    context.beginPath();
    /* vertical lines */
    for (var x = 0; x <= kPixelWidth; x += kPieceWidth) {
	    context.moveTo(0.5 + x, 0);
	    context.lineTo(0.5 + x, kPixelHeight);
    }
    /* horizontal lines */
    for (var y = 0; y <= kPixelHeight; y += kPieceHeight) {
      context.moveTo(0, 0.5 + y);
	    context.lineTo(kPixelWidth, 0.5 +  y);
    }
    context.strokeStyle = "#ccc";
    context.stroke();
    for (i = 0; i < kBoardHeight; i++){
      for (j = 0; j < kBoardWidth; j++){
        if (selected[i][j] === 1){
          drawPiece(context, new Cell(i,j));
        }
      }
    }
    insertNumbers(context);
}
 
function drawPiece(context, c) {
    var col = c.col;
    var row = c.row;
    var x = (col * kPieceWidth) + (kPieceWidth/2);
    var y = (row * kPieceHeight) + (kPieceHeight/2);
    var radius = (kPieceWidth/2) - (kPieceWidth/10);
    context.beginPath();
    context.arc(x, y, radius, 0, Math.PI*2, false);
    context.closePath();
    context.strokeStyle = "#000";
    context.stroke();
	  context.fillStyle = "#000";
    context.fill();
}

function initSelected(){
  var selected = []; 
  for (i = 0; i < kBoardHeight; i++){
    selected.push([]);
    for (j = 0; j < kBoardWidth; j++){
      selected[i].push(0);
    }
  }
  return selected;
}

$(function() {
  var can = $('<canvas></canvas>');
  var feedbackdiv = $('<div id="feedback"></div>');

  rawjscanvas = can.get(0);
  rawjscanvas.id = "tutorial";
  rawjscanvas.width = kPixelWidth;
  rawjscanvas.height = kPixelHeight;
  $('body').append(can);
  $('body').append(feedbackdiv);
  context = rawjscanvas.getContext('2d');
 
  selected = initSelected();
 
  drawBoard(context, selected);

  can.click(function(ev){
    cell = getCursorPosition(ev);
    selecting = selected[cell.row][cell.col] === 0;
    if (selecting) {
      selected[cell.row][cell.col] = 1;
      ws.send('1-'+cell.row+'-'+cell.col);
    } else {
      selected[cell.row][cell.col] = 0;
      ws.send('0-'+cell.row+'-'+cell.col);
    }
    //drawBoard(context, selected);
  });

  ws.onmessage = function(evt) {
    feedbackdiv.html(evt.data);
    var a = JSON.parse(evt.data);
    selected = initSelected();
    for (var i = 0; i < a.length; i++){
      rc = divmod(a[i], 12);
      selected[rc[0]][rc[1]] = 1;
    }
    drawBoard(context, selected);
  }
  ws.onopen = function(evt) {
    $('#conn_status').html('<b>Connected</b>');
    //ws.send('Connected');
  }
  ws.onerror = function(evt) {
    $('#conn_status').html('<b>Error</b>');
  }
  ws.onclose = function(evt) {
    $('#conn_status').html('<b>Closed</b>');
  }
});



// global for to play



</script> 
</body> 
</html> 

