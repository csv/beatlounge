<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>Canvas Event</title>
</head>
<body>

<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

<script type="text/javascript">


function Cell(row, col) {
    this.row = row;
    this.col = col;
}

function drawRect(context, x, y, w, h) {
  context.beginPath();
  context.rect(x,y,w,h);
  context.closePath();
  context.stroke();
}

function LevelRoller(canvas, options){
  var defaultOptions = {
    "id": "level",
    "BoardWidth": 24*16,
    "BoardHeight": 128,
    "PieceWidth": 3,
    "PieceHeight": 1,
    "strokeStyle": "#000",
  }
  if (typeof options == 'object') {
		options = $.extend(defaultOptions, options);
	} else {
		options = defaultOptions;
	}

  this.canvas = canvas;
  var ctx = canvas.getContext('2d');
  ctx.strokeStyle = options["strokeStyle"];
  var BoardWidth = options["BoardWidth"]
  var BoardHeight = options["BoardHeight"]
  var PieceWidth = options["PieceWidth"]
  var PieceHeight = options["PieceHeight"]
  var PixelWidth = PieceWidth * BoardWidth + 1;
  var PixelHeight = PieceHeight * BoardHeight + 1;

  this.canvas.id = options["id"];
  this.canvas.width = PixelWidth;
  this.canvas.height = PixelHeight;

  var defaultLevel = 100;
  var selected = {};
  this.dragging = false;

  draw = function() {
    var value;
    console.log(ctx);
    console.log(PixelWidth, PixelHeight);
    ctx.clearRect(0, 0, PixelWidth, PixelHeight);
    drawRect(ctx, 0, 0, PixelWidth, PixelHeight);
    for (i = 0; i < BoardWidth; i++){
      if (selected[i] === undefined){
        value = defaultLevel;
      } else {
        value = selected[i];
      }
      drawRect(ctx, i*PieceWidth, BoardHeight - value, PieceWidth, PieceHeight);
    }
  }
  this.draw = draw;

  // TODO, factor this out to parent class for rilz
  getCursorPosition = function(e) {
    var x;
    var y;
    if (e.pageX != undefined && e.pageY != undefined) {
    	x = e.pageX;
    	y = e.pageY;
    }
    else {
    	x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
    	y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }
    x -= e.currentTarget.offsetLeft;
    y -= e.currentTarget.offsetTop;
    x = Math.min(x, BoardWidth * PieceWidth);
    y = Math.min(y, BoardHeight * PieceHeight);
    var cell = new Cell(Math.floor(y/PieceHeight), Math.floor(x/PieceWidth));
    return cell;
  }

  this.drag = function(e) {
    var cell = getCursorPosition(e);
    console.log(cell);
    selected[cell.col] = BoardHeight - cell.row;
    draw();
  };

  this.mousedown = function(e){
    var cell = getCursorPosition(e);
    console.log(cell);
    dragging = true;
    this.canvas.onmousemove = this.drag;
  };

  this.mouseup = function(e){
    canvas.onmousemove = null;
    dragging = false;
    console.log('up');
  };

}

$(function() {
  var can = $('<canvas></canvas>');
  console.log(can);
  var canvas = can.get(0);
  console.log(canvas);
  $('body').append(can);

  var levelroller = new LevelRoller(canvas);
  console.log(levelroller);
  levelroller.draw();

  canvas.onmousedown = function(e) { return levelroller.mousedown(e); }
  canvas.onmouseup = function(e) { return levelroller.mouseup(e); }

});

</script>

</body>
</html>

