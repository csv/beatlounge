<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>Canvas Event</title>
</head>
<body>

<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

<script type="text/javascript">


function Cell(row, col) {
    this.row = row;
    this.col = col;
}

function drawRect(context, x, y, w, h) {
  context.beginPath();
  context.rect(x,y,w,h);
  context.closePath();
  context.stroke();
}

function LevelRoller(canvas, options){
  var self = this;

  var defaultOptions = {
    "id": "level",
    "BoardWidth": 24*16,
    "BoardHeight": 128,
    "PieceWidth": 3,
    "PieceHeight": 1,
    "strokeStyle": "#000",
    "defaultLevel": 100,
    "wsAddress": location.hostname+":8347/vol"
  }
  if (typeof options == 'object') {
		options = $.extend(defaultOptions, options);
	} else {
		options = defaultOptions;
	}

  self.ws = new WebSocket("ws://"+options["wsAddress"]);
  self.canvas = canvas;
  self.ctx = canvas.getContext('2d');
  self.ctx.strokeStyle = options["strokeStyle"];
  var BoardWidth = options["BoardWidth"]
  var BoardHeight = options["BoardHeight"]
  var PieceWidth = options["PieceWidth"]
  var PieceHeight = options["PieceHeight"]
  var PixelWidth = PieceWidth * BoardWidth + 1;
  var PixelHeight = PieceHeight * BoardHeight + 1;

  self.canvas.id = options["id"];
  self.canvas.width = PixelWidth;
  self.canvas.height = PixelHeight;
  self.defaultLevel = options["defaultLevel"];
  self.selected = {};
  self.dragging = false;
  self.lastcol = undefined; // Too know what direction we are dragging

  function draw() {
    var value;
    self.ctx.clearRect(0, 0, PixelWidth, PixelHeight);
    drawRect(self.ctx, 0, 0, PixelWidth, PixelHeight);
    for (i = 0; i < BoardWidth; i++){
      if (self.selected[i] == undefined){
        self.selected[i] = self.defaultLevel;
        value = self.defaultLevel;
      } else {
        value = self.selected[i];
      }
      drawRect(self.ctx, i*PieceWidth, BoardHeight - value, PieceWidth, PieceHeight);
    }
  }
  self.draw = draw;

  function getCursorPosition(e) {
    var x;
    var y;
    if (e.pageX != undefined && e.pageY != undefined) {
    	x = e.pageX;
    	y = e.pageY;
    }
    else {
    	x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
    	y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }
    x -= e.currentTarget.offsetLeft;
    y -= e.currentTarget.offsetTop;
    x = Math.min(x, BoardWidth * PieceWidth);
    y = Math.min(y, BoardHeight * PieceHeight);
    var cell = new Cell(Math.floor(y/PieceHeight), Math.floor(x/PieceWidth));
    return cell;
  }
  self.getCursorPosition = getCursorPosition;

  self.drag = function(e) {
    var cell = self.getCursorPosition(e);
    var difference = cell.col - self.lastcol;

    var level = BoardHeight - cell.row;
    self.selected[cell.col] = level;

    if (Math.pow(difference, 2) > 1){
      for (i=self.lastcol; i <cell.col; i++){
        self.selected[i] = level;
      }
      for (i=self.lastcol; i > cell.col; i--){
        self.selected[i] = level;
      }

    }
    self.lastcol = cell.col;
    msg = JSON.stringify(self.selected);
    console.log(msg);
    self.ws.send(msg);
    self.draw();
  };

  self.mousedown = function(e){
    var cell = self.getCursorPosition(e);
    self.lastcol = cell.col;
    var level = BoardHeight - cell.row;
    self.selected[cell.col] = level;
    self.dragging = true;
    self.canvas.onmousemove = self.drag;

    self.selected[cell.col] = level;
    //console.log(self.selected);
    //self.ws.send(self.selected);
    self.draw();
  };

  self.mouseup = function(e){
    self.canvas.onmousemove = null;
    self.dragging = false;
  };

  self.ws.onmessage = function(e){
    console.log(e);
    //self.selected = JSON.parse(e.data);
    //self.draw();
  };
  self.ws.onopen = function(e){
    console.log("open");
  };
  self.ws.onerror = function(e){
    console.log("error");
  };
  self.ws.onclose = function(e){
    console.log("close");
  };

}

$(function() {
  var can = $('<canvas></canvas>');
  console.log(can);
  var canvas = can.get(0);
  console.log(canvas);
  $('body').append(can);

  var levelroller = new LevelRoller(canvas);
  console.log(levelroller);
  levelroller.draw();

  canvas.onmousedown = levelroller.mousedown;
  canvas.onmouseup = levelroller.mouseup;

});

</script>

</body>
</html>

